{
  "aggregations": {
    "service_name": {
      "terms": {
        "field": "serviceName",
        "size": 500,
        "min_doc_count": 1,
        "shard_min_doc_count": 0,
        "show_term_doc_count_error": false,
        "order": [
          {
            "_count": "desc"
          },
          {
            "_key": "asc"
          }
        ]
      },
      "aggregations": {
        "average_latency_nanos": {
          "avg": {
            "field": "durationInNanos"
          }
        },
        "average_latency": {
          "bucket_script": {
            "buckets_path": {
              "count": "_count",
              "latency": "average_latency_nanos.value"
            },
            "script": "Math.round(params.latency / 10000) / 100.0"
          }
        },
        "error_count": {
          "filter": {
            "term": {
              "status.code": "2"
            }
          }
        },
        "error_rate": {
          "bucket_script": {
            "buckets_path": {
              "total": "_count",
              "errors": "error_count._count"
            },
            "script": "params.errors / params.total * 100"
          }
        }
      }
    }
  }
}
